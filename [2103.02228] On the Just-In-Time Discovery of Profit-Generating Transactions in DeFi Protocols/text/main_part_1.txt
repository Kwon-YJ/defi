ON THE JUST-IN-TIME DISCOVERY OF PROFIT-GENERATING TRANSACTIONS IN DEFI PROTOCOLS

Authors: Liyi Zhou, Kaihua Qin, Antoine Cully, Benjamin Livshits, Arthur Gervais
Imperial College London, United Kingdom

ABSTRACT

Decentralized Finance (DeFi) is a blockchain-asset-enabled finance ecosystem with millions of daily USD transaction volume, billions of locked up USD, as well as a plethora of newly emerging protocols (for lending, staking, and exchanges). Because all transactions, user balances, and total value locked in DeFi are publicly readable, a natural question that arises is: how can we automatically craft profitable transactions across the intertwined DeFi platforms?

In this paper, we investigate two methods that allow us to automatically create profitable DeFi trades, one well-suited to arbitrage and the other applicable to more complicated settings. We first adopt the Bellman-Ford-Moore algorithm with DeFiPoser-ARB and then create logical DeFi protocol models for a theorem prover in DeFiPoser-SMT. While DeFiPoser-ARB focuses on DeFi transactions that form a cycle and performs very well for arbitrage, DeFiPoser-SMT can detect more complicated profitable transactions. We estimate that DeFiPoser-ARB and DeFiPoser-SMT can generate an average weekly revenue of 191.48 ETH and 72.44 ETH respectively, with the highest transaction revenue being 81.31 ETH and 22.40 ETH respectively. We further show that DeFiPoser-SMT finds the known economic bZx attack from February 2020, which yields $0.48M USD. Our forensic investigations show that this opportunity existed for 69 days and could have yielded more revenue if exploited one day earlier. Our evaluation spans 150 days, given 96 DeFi protocol actions, and 25 assets.

Looking beyond the financial gains mentioned above, forks deteriorate the blockchain consensus security, as they increase the risks of double-spending and selfish mining. We explore the implications of DeFiPoser-ARB and DeFiPoser-SMT on blockchain consensus. Specifically, we show that the trades identified by our tools exceed the Ethereum block reward by up to 874×. Given optimal adversarial strategies provided by a Markov Decision Process (MDP), we quantify the value threshold at which a profitable transaction qualifies as Miner Extractable Value (MEV) and would incentivize MEV-aware miners to fork the blockchain. For instance, we find that on Ethereum, a miner with a hash rate of 10% would fork the blockchain if an MEV opportunity exceeds 4× the block reward.

1. INTRODUCTION

Blockchain-based decentralized finance protocols (commonly referred to as DeFi) have attracted a recent surge in popularity and value stored exceeding $13 billion USD. The currently most popular DeFi platforms are based on the Ethereum blockchain and its system of smart contracts, which regularly gives nascence to new applications, mirrored and inspired by the traditional centralized finance system. Examples are asset exchanges, margin trading, lending/borrowing platforms, and derivatives. DeFi, moreover, can surprise with novel use-cases such as constant product market maker exchanges and flash loans - instant loans where the lender bears no risk that the borrower does not repay the loan.

[FIGURE 1: DeFiPoser-ARB and DeFiPoser-SMT system overview. In DeFiPoser-SMT, we (2) Create logical models, (3) paths are created and trimmed with heuristics and (4) used within a theorem prover to generate a transaction. In DeFiPoser-ARB we (2) build a graph of the blockchain state, (3) identify negative cycles, (4) perform a local search and repeat. The transaction with the highest revenue is (4) concretely evaluated before being mined in the next block.]

A peculiarity of DeFi platforms is their ability to inter-operate; e.g., one may borrow a cryptocurrency asset on one platform, exchange the asset on another, and for instance, lend the resulting asset on a third system. DeFi's composability has led to the emergence of chained trading and arbitrage opportunities throughout the tightly intertwined DeFi space. Reasoning about what this easy composition entails is not particularly simple; on one side, atomic composition allows to perform risk-free arbitrage - that is to equate asset prices on different DeFi markets. Arbitrage is a benign and important endeavor to keep markets synchronized.

On the other side, we have seen multi-million-revenue trades that cleverly use the technique of flash loans to exploit economic states in DeFi protocols (e.g., the economic attack on bZx, Harvest Finance, Value Defi and others). While exploiting economic states, however, is not a security attack in the traditional sense, the practitioners' community often frames these high-revenue trades as "hacks." Yet, the executing trader follows the rules set forth by the deployed smart contracts. Irrespective of the framing, liquidity providers engaging with DeFi experience millions of USD in unexpected losses. This highlights the need for automated tools that help protocol designers and liquidity providers to understand arbitrage and financial implications in general when engaging with DeFi protocols.

DeFiPoser-ARB and DeFiPoser-SMT

This paper presents two tools (cf. Figure 1) that automatically create transactions to compose existing DeFi protocols to generate revenue that can be extracted from the Ethereum ecosystem. They are designed to run in real-time: at every block, they can find (and execute) a new profit-generating transaction; we show how our running time of an unoptimized implementation requires an average of 6.43 seconds and 5.39 seconds on a recent Ethereum block (for DeFiPoser-ARB and DeFiPoser-SMT respectively), which is below Ethereum's average block time of 13.5 seconds.

We would like to point out that DeFiPoser-ARB and DeFiPoser-SMT, are best-effort tools: because the state of the blockchain and DeFi platforms may change at each block, it is important to operate in real-time, otherwise found trading opportunities might be outdated. Therefore, we made the choice of prioritizing execution speed over completeness, and we do not claim to find optimal strategies.

To the best of our knowledge, we are the first to provide automated transaction search mechanisms for composable DeFi protocols. The main risks for a trader using the tools that we consider within this work are currency exposure (i.e., price volatility risks) and the blockchain transaction fees. We discover that significant revenue can be generated with less than 1 ETH of initial capital when using flash loans.

Our contributions are as follows:

• DeFiPoser-ARB: We build a directed DeFi market graph and identify negative cycles with the Bellman-Ford-Moore algorithm. A local search then allows us to discover parameters for profitable arbitrage transactions in near-real-time (average of 6.43 seconds per block).

• DeFiPoser-SMT and Space Reduction: To discover more demanding trades than arbitrage, we model the DeFi systems using a state transition model, which we translate to a logical representation in the Z3 theorem prover. We introduce heuristics to significantly prune the search space to achieve a near real-time transaction discovery (average of 5.39 seconds per block).

• Miner Extractable Value (MEV) and Security: We show how DeFiPoser-SMT discovers the economic attack on bZx, which yields over $0.48M USD, and that this opportunity window was open for over 69 days. Given optimal adversarial mining strategies provided by a Markov Decision Process, we show quantitatively that MEV opportunities can deteriorate the blockchain security. For example, a rational MEV-aware miner with a hash rate of 10% will fork the blockchain if an MEV opportunity exceeds 4 times the block reward and the miner failed to claim the source of MEV.

• Trading Strategy Validation: We validate the trading strategies discovered by DeFiPoser-ARB and DeFiPoser-SMT on a locally-deployed blockchain that mirrors the real network. We estimate that the found strategies yield 4103.22 ETH and 1552.32 ETH of profit between the Ethereum block 9,100,000 to 10,050,000 (150 days from December 2019 to May 2020). We demonstrate that our tools' capital requirements are minimal: the majority of the strategies require less than 150 ETH (60,000 USD), and only 0.4 ETH (160 USD) when using flash loans.

Paper organization

The remainder of the paper is organized as follows. Section 2 elaborates on the DeFi background, discusses stable coins and flash loans. Section 3 describes how we encode DeFi protocols into state transition models. Section 4 applies negative cycle detection to find DeFi arbitrage opportunities. Section 5 presents our heuristics and techniques to enable the autonomous discovery of adversarial strategies. Section 6 presents our empirical evaluation and quantitative analysis of the found strategies on previous Ethereum blockchain blocks. Section 7 discusses DeFiPoser's blockchain security implication. We discuss related works in Section 8 and conclude the paper in Section 9.